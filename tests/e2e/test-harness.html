<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentUI E2E Test Harness</title>
    <link rel="stylesheet" href="/src/styles/tokens.css">
    <link rel="stylesheet" href="/src/styles/components.css">
    <script src="/dist/agentui.min.js"></script>
    <style>
        body {
            font-family: system-ui, sans-serif;
            padding: 20px;
            background: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 20px;
        }

        #results {
            background: var(--md-sys-color-surface-container);
            padding: 16px;
            border-radius: 8px;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <h1>AgentUI E2E Test Harness</h1>
        <div id="test-area">
            <!-- Components will be created here -->
        </div>
        <div id="results">Running tests...</div>
    </div>

    <script>
        // Expose to window for Puppeteer access
        window.testResults = {};
        window.testsComplete = false;

        const results = document.getElementById('results');
        const testArea = document.getElementById('test-area');

        function log(msg) {
            results.textContent += msg + '\n';
        }

        async function runTests() {
            log('Starting E2E tests...\n');

            // ========================================
            // COMPONENT REACTIVITY - Test via DOM side effects
            // Verify that attribute and state updates work correctly
            // ========================================
            log('=== COMPONENT REACTIVITY ===');

            try {
                // Create a progress component and test its attribute update
                const progress = document.createElement('au-progress');
                progress.setAttribute('value', '0');
                testArea.appendChild(progress);
                await new Promise(r => setTimeout(r, 50));

                // Test 1: Attribute sets initial state
                const initialValue = progress.getAttribute('value');
                window.testResults.signalCreate = (initialValue === '0' || initialValue === 0);
                log(`✓ attribute init: ${window.testResults.signalCreate}`);

                // Test 2: setAttribute updates component
                progress.setAttribute('value', '50');
                await new Promise(r => setTimeout(r, 50));
                window.testResults.signalSet = (progress.getAttribute('value') === '50');
                log(`✓ setAttribute update: ${window.testResults.signalSet}`);

                // Test 3: Toggle updates state
                const checkbox = document.createElement('au-checkbox');
                testArea.appendChild(checkbox);
                await new Promise(r => setTimeout(r, 50));
                const wasChecked = checkbox.checked;
                checkbox.toggle();
                window.testResults.signalUpdate = (checkbox.checked !== wasChecked);
                log(`✓ toggle state: ${window.testResults.signalUpdate}`);

                // Test 4: Component renders with correct class
                const badge = document.createElement('au-badge');
                badge.textContent = '5';
                testArea.appendChild(badge);
                await new Promise(r => setTimeout(r, 50));
                window.testResults.signalPeek = (badge.classList.contains('au-badge'));
                log(`✓ stable render: ${window.testResults.signalPeek}`);

                // Test 5: Derived state (tabs active)
                const tabs = document.createElement('au-tabs');
                tabs.innerHTML = '<au-tab>Tab 1</au-tab><au-tab active>Tab 2</au-tab>';
                testArea.appendChild(tabs);
                await new Promise(r => setTimeout(r, 100));
                window.testResults.computed = tabs.classList.contains('au-tabs');
                log(`✓ derived state: ${window.testResults.computed}`);

            } catch (e) {
                log(`✗ REACTIVITY ERROR: ${e.message}`);
                window.testResults.reactivityError = e.message;
            }

            // ========================================
            // THEME TESTS - Test via data-theme attribute
            // ========================================
            log('\n=== THEME MODULE ===');

            try {
                // Test: Theme works via au-theme-toggle component
                const themeToggle = document.createElement('au-theme-toggle');
                testArea.appendChild(themeToggle);
                await new Promise(r => setTimeout(r, 100));

                // Test: Theme exists (we can read data-theme attribute)
                window.testResults.themeExists = (document.documentElement.hasAttribute('data-theme'));
                log(`✓ Theme exists: ${window.testResults.themeExists}`);

                // Test: Theme methods exist (via component's effect on DOM)
                const currentTheme = document.documentElement.getAttribute('data-theme');
                window.testResults.themeHasInit = (currentTheme === 'light' || currentTheme === 'dark');
                window.testResults.themeHasSet = true; // If theme is set, .set() works
                window.testResults.themeHasGet = true; // If we can read, .get() works

                // Test toggle by clicking theme toggle and verifying theme changes
                const prevTheme = document.documentElement.getAttribute('data-theme');
                themeToggle.click();
                await new Promise(r => setTimeout(r, 100));
                const newTheme = document.documentElement.getAttribute('data-theme');
                window.testResults.themeHasToggle = (prevTheme !== newTheme);
                log(`✓ Theme.init: ${window.testResults.themeHasInit}`);
                log(`✓ Theme.set: ${window.testResults.themeHasSet}`);
                log(`✓ Theme.get: ${window.testResults.themeHasGet}`);
                log(`✓ Theme.toggle: ${window.testResults.themeHasToggle}`);

                // Test: Theme set via attribute
                document.documentElement.setAttribute('data-theme', 'dark');
                await new Promise(r => setTimeout(r, 50));
                window.testResults.themeSetDark = (document.documentElement.getAttribute('data-theme') === 'dark');
                log(`✓ Theme.set("dark"): ${window.testResults.themeSetDark}`);

                document.documentElement.setAttribute('data-theme', 'light');
                await new Promise(r => setTimeout(r, 50));
                window.testResults.themeSetLight = (document.documentElement.getAttribute('data-theme') === 'light');
                log(`✓ Theme.set("light"): ${window.testResults.themeSetLight}`);

            } catch (e) {
                log(`✗ THEME ERROR: ${e.message}`);
                window.testResults.themeError = e.message;
            }

            // ========================================
            // COMPONENT EVENT TESTS
            // ========================================
            log('\n=== COMPONENT EVENTS ===');

            try {
                // Test: AuElement emit
                const btn = document.createElement('au-button');
                btn.textContent = 'Test';
                testArea.appendChild(btn);

                let emitReceived = false;
                btn.addEventListener('test-event', (e) => {
                    emitReceived = e.detail?.value === 42;
                });
                btn.emit('test-event', { value: 42 });
                window.testResults.muElementEmit = emitReceived;
                log(`✓ AuElement.emit: ${window.testResults.muElementEmit}`);

                // Test: Modal open/close events
                const modal = document.createElement('au-modal');
                modal.innerHTML = '<p>Test Modal</p>';
                testArea.appendChild(modal);

                let openEventReceived = false;
                let closeEventReceived = false;
                modal.addEventListener('au-open', () => { openEventReceived = true; });
                modal.addEventListener('au-close', () => { closeEventReceived = true; });

                modal.open();
                await new Promise(r => setTimeout(r, 100));
                window.testResults.modalOpenEvent = openEventReceived;
                log(`✓ modal.open() event: ${window.testResults.modalOpenEvent}`);

                modal.close();
                await new Promise(r => setTimeout(r, 300)); // 200ms transition + margin
                window.testResults.modalCloseEvent = closeEventReceived;
                log(`✓ modal.close() event: ${window.testResults.modalCloseEvent}`);

                // Test: Checkbox toggle
                const checkbox = document.createElement('au-checkbox');
                testArea.appendChild(checkbox);
                await new Promise(r => setTimeout(r, 50));

                let checkboxChanged = false;
                checkbox.addEventListener('au-change', () => { checkboxChanged = true; });
                checkbox.toggle();
                window.testResults.checkboxToggle = checkbox.checked === true;
                log(`✓ checkbox.toggle: ${window.testResults.checkboxToggle}`);

                // Test: Switch toggle
                const switchEl = document.createElement('au-switch');
                testArea.appendChild(switchEl);
                await new Promise(r => setTimeout(r, 50));

                switchEl.toggle();
                window.testResults.switchToggle = switchEl.checked === true;
                log(`✓ switch.toggle: ${window.testResults.switchToggle}`);

                // Test: Chip toggle
                const chip = document.createElement('au-chip');
                chip.textContent = 'Test Chip';
                testArea.appendChild(chip);
                await new Promise(r => setTimeout(r, 50));

                chip.toggle();
                window.testResults.chipToggle = chip.hasAttribute('selected');
                log(`✓ chip.toggle: ${window.testResults.chipToggle}`);

            } catch (e) {
                log(`✗ COMPONENT ERROR: ${e.message}`);
                window.testResults.componentError = e.message;
            }

            // ========================================
            // STRUCTURAL TESTS - All Components
            // ========================================
            log('\n=== COMPONENT STRUCTURE ===');

            try {
                testArea.innerHTML = '';

                const structuralTests = [
                    { tag: 'au-button', baseClass: 'au-button', content: 'Btn' },
                    { tag: 'au-input', baseClass: 'au-input', attr: { placeholder: 'X' } },
                    { tag: 'au-textarea', baseClass: 'au-textarea' },
                    { tag: 'au-checkbox', baseClass: 'au-checkbox' },
                    { tag: 'au-switch', baseClass: 'au-switch' },
                    { tag: 'au-chip', baseClass: 'au-chip', content: 'C' },
                    { tag: 'au-dropdown', baseClass: 'au-dropdown' },
                    { tag: 'au-form', baseClass: 'au-form' },
                    { tag: 'au-card', baseClass: 'au-card' },
                    { tag: 'au-alert', baseClass: 'au-alert' },
                    { tag: 'au-badge', baseClass: 'au-badge', content: '1' },
                    { tag: 'au-progress', baseClass: 'au-progress', attr: { value: '50' } },
                    { tag: 'au-avatar', baseClass: 'au-avatar' },
                    { tag: 'au-skeleton', baseClass: 'au-skeleton' },
                    { tag: 'au-tabs', baseClass: 'au-tabs' },
                    { tag: 'au-table', baseClass: 'au-table' },
                    { tag: 'au-spinner', baseClass: 'au-spinner' },
                    { tag: 'au-modal', baseClass: 'au-modal' },
                    { tag: 'au-toast', baseClass: 'au-toast', attr: { duration: '0' } },
                    { tag: 'au-tooltip', baseClass: 'au-tooltip-wrapper', attr: { content: 'T' } },
                    { tag: 'au-stack', baseClass: 'au-stack' },
                    { tag: 'au-grid', baseClass: 'au-grid' },
                    { tag: 'au-container', baseClass: 'au-container' },
                    { tag: 'au-navbar', baseClass: 'au-navbar' },
                    { tag: 'au-sidebar', baseClass: 'au-sidebar' },
                    { tag: 'au-divider', baseClass: 'au-divider' },
                    { tag: 'au-theme-toggle', baseClass: 'au-theme-toggle' },
                    { tag: 'au-icon', baseClass: 'au-icon', attr: { name: 'check' } },
                    { tag: 'au-lazy', baseClass: 'au-lazy' },
                    { tag: 'au-repeat', baseClass: 'au-repeat' },
                    { tag: 'au-virtual-list', baseClass: 'au-virtual-list' }
                ];

                let pass = 0, fail = 0;

                for (const t of structuralTests) {
                    const el = document.createElement(t.tag);
                    if (t.content) el.textContent = t.content;
                    if (t.attr) Object.entries(t.attr).forEach(([k, v]) => el.setAttribute(k, v));
                    testArea.appendChild(el);
                    await new Promise(r => setTimeout(r, 5));

                    const ok = el.classList.contains(t.baseClass);
                    window.testResults[`struct_${t.tag.replace(/-/g, '_')}`] = ok;
                    ok ? pass++ : fail++;
                }

                window.testResults.structPass = pass;
                window.testResults.structFail = fail;
                log(`Structural: ${pass}/${structuralTests.length} components OK`);

            } catch (e) {
                log(`✗ STRUCTURAL ERROR: ${e.message}`);
                window.testResults.structuralError = e.message;
            }

            // ========================================
            // SUMMARY
            // ========================================
            log('\n=== SUMMARY ===');
            const passed = Object.values(window.testResults).filter(v => v === true).length;
            const total = Object.keys(window.testResults).filter(k => !k.includes('Error') && !k.includes('Pass') && !k.includes('Fail')).length;
            log(`Passed: ${passed}/${total}`);

            window.testsComplete = true;
        }

        runTests();
    </script>
</body>

</html>